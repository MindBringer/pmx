  server {
  listen 443 ssl;
  server_name ai.intern;

  ssl_certificate     /etc/ssl/selfsigned/ai.intern.crt;
  ssl_certificate_key /etc/ssl/selfsigned/ai.intern.key;
  ssl_protocols       TLSv1.2 TLSv1.3;

  client_max_body_size 2G;
  client_body_timeout  3600s;
  send_timeout         3600s;

  # 0) Nur /rag exakt -> /rag/ normalisieren (schadet nicht)
  location = /rag {
    return 301 /rag/;
  }

  # 1) ALLE Job-Routen (/rag/jobs und /rag/jobs/...) — Präfix NICHT strippen
  #    => KEIN trailing slash bei proxy_pass
  location ^~ /rag/jobs {
    proxy_pass         http://127.0.0.1:8082;   # /rag bleibt erhalten
    proxy_http_version 1.1;
    proxy_set_header   Host               $host;
    proxy_set_header   X-Real-IP          $remote_addr;
    proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto  $scheme;

    # SSE/Streaming ok
    proxy_set_header   Connection         "";
    proxy_buffering    off;
    proxy_cache        off;
    proxy_read_timeout 1h;
    proxy_send_timeout 1h;

    # (Optional) CORS
    add_header Access-Control-Allow-Origin  *;
    add_header Access-Control-Allow-Methods 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
    add_header Access-Control-Allow-Headers 'Content-Type, Authorization, X-API-Key' always;
    if ($request_method = OPTIONS) { add_header Content-Length 0; return 204; }
  }

  # 1.5) Audio-Services auf AI-VM (192.168.30.43)
  #      WICHTIG: trailing Slash + Zielpfad, damit /rag/transcribe/* → /transcribe/* umgeschrieben wird
  # exakt /rag/transcribe  -> /transcribe   (ohne Slash, damit KEIN Redirect)
  location = /rag/transcribe {
    proxy_pass         http://192.168.30.43:6080/transcribe;
    proxy_http_version 1.1;

    proxy_set_header   Host               $host;
    proxy_set_header   X-Real-IP          $remote_addr;
    proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto  $scheme;

    # CORS inkl. Preflight (wichtig wegen x-api-key)
    add_header Access-Control-Allow-Origin  * always;
    add_header Access-Control-Allow-Methods 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
    add_header Access-Control-Allow-Headers 'Content-Type, Authorization, X-API-Key' always;
    if ($request_method = OPTIONS) { add_header Content-Length 0; return 204; }

    # Timeouts/Uploadkomfort
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_connect_timeout 600s;
    proxy_request_buffering off;
  }

  # Präfix /rag/transcribe/...  -> /transcribe/...  (falls du später Subrouten nutzt)
  location ^~ /rag/transcribe/ {
    proxy_pass         http://192.168.30.43:6080/transcribe/;
    proxy_http_version 1.1;

    proxy_set_header   Host               $host;
    proxy_set_header   X-Real-IP          $remote_addr;
    proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto  $scheme;

    proxy_read_timeout 3600s;
    proxy_connect_timeout 600s;
    proxy_send_timeout 3600s;
    proxy_request_buffering off;

    # CORS optional
    add_header Access-Control-Allow-Origin  *;
    add_header Access-Control-Allow-Methods 'GET, POST, PUT, PATCH, DELETE, OPTIONS';
    add_header Access-Control-Allow-Headers 'Content-Type, Authorization, X-API-Key';
    if ($request_method = OPTIONS) { add_header Content-Length 0; return 204; }
  }

  # exakt /rag/speakers  -> /speakers
  location = /rag/speakers {
    proxy_pass         http://192.168.30.43:6080/speakers;
    proxy_http_version 1.1;
    proxy_set_header   Host               $host;
    proxy_set_header   X-Real-IP          $remote_addr;
    proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto  $scheme;
    add_header Access-Control-Allow-Origin  *;
    add_header Access-Control-Allow-Methods 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
    add_header Access-Control-Allow-Headers 'Content-Type, Authorization, X-API-Key' always;
    if ($request_method = OPTIONS) { add_header Content-Length 0; return 204; }
  }

  # Präfix /rag/speakers/... -> /speakers/...  (trailing slash: /rag/speakers/ wird entfernt)
  location ^~ /rag/speakers/ {
    proxy_pass         http://192.168.30.43:6080/speakers/;
    proxy_http_version 1.1;
    proxy_set_header   Host               $host;
    proxy_set_header   X-Real-IP          $remote_addr;
    proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto  $scheme;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
    proxy_connect_timeout 60s;

    add_header Access-Control-Allow-Origin  *;
    add_header Access-Control-Allow-Methods 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
    add_header Access-Control-Allow-Headers 'Content-Type, Authorization, X-API-Key' always;
    if ($request_method = OPTIONS) { add_header Content-Length 0; return 204; }
  }

  # (Optional) Separate Diarize-API auf AI-VM (falls aktiviert)
  location ^~ /rag/diarize/ {
    proxy_pass         http://192.168.30.43:6081/diarize/;
    proxy_http_version 1.1;

    proxy_set_header   Host               $host;
    proxy_set_header   X-Real-IP          $remote_addr;
    proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto  $scheme;

    proxy_read_timeout 600s;
    proxy_connect_timeout 600s;
    proxy_send_timeout 600s;

    # CORS optional
    add_header Access-Control-Allow-Origin  *;
    add_header Access-Control-Allow-Methods 'GET, POST, PUT, PATCH, DELETE, OPTIONS';
    add_header Access-Control-Allow-Headers 'Content-Type, Authorization, X-API-Key';
    if ($request_method = OPTIONS) { add_header Content-Length 0; return 204; }
  }

  # 1.6) vLLM-Instanzen auf AI-VM (192.168.30.43)

  # vLLM Allrounder → /v1/llm/...
  location ^~ /v1/llm/ {
    proxy_pass         http://192.168.30.43:8001/v1/;  # Achtung: trailing slash
    proxy_http_version 1.1;
    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }

  # vLLM LoRA-Basis → /v1/base/...
  location ^~ /v1/base/ {
    proxy_pass         http://192.168.30.43:8002/v1/;
    proxy_http_version 1.1;
    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }
  # 2) Restliche /rag/*-Routen (index, query, tags, docs, …):
  #    Präfix STRIPPEN: /rag/x -> /x
  #    => trailing slash bei proxy_pass!
  location ^~ /rag/ {
    proxy_pass         http://127.0.0.1:8082/;  # <— mit Slash, /rag wird entfernt
    proxy_http_version 1.1;

    proxy_set_header   Host               $host;
    proxy_set_header   X-Real-IP          $remote_addr;
    proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto  $scheme;

    proxy_read_timeout 3600s;
    proxy_connect_timeout 120s;
    proxy_send_timeout 3600s;

    # CORS optional
    add_header Access-Control-Allow-Origin  *;
    add_header Access-Control-Allow-Methods 'GET, POST, PUT, PATCH, DELETE, OPTIONS';
    add_header Access-Control-Allow-Headers 'Content-Type, Authorization, X-API-Key';
    if ($request_method = OPTIONS) { add_header Content-Length 0; return 204; }
  }

  # 3) Statisches UI unter /ui/
  location ^~ /ui/ {
    root  /var/www;
    index index.html;
    try_files $uri $uri/ /ui/index.html;
  }

  # 4) n8n Webhooks (falls genutzt)
  location ^~ /webhook/ {
    proxy_pass         http://127.0.0.1:5678/webhook/;
    proxy_http_version 1.1;
    proxy_set_header   Upgrade            $http_upgrade;
    proxy_set_header   Connection         "upgrade";
    proxy_set_header   Host               $host;
    proxy_set_header   X-Real-IP          $remote_addr;
    proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto  $scheme;
    proxy_read_timeout 3600s;
    proxy_connect_timeout 600s;
    proxy_send_timeout 3600s;
  }

  # 5) n8n UI als Fallback
  location / {
    proxy_pass         http://127.0.0.1:5678;
    proxy_http_version 1.1;
    proxy_set_header   Upgrade            $http_upgrade;
    proxy_set_header   Connection         "upgrade";
    proxy_set_header   Host               $host;
    proxy_set_header   X-Real-IP          $remote_addr;
    proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto  $scheme;
    proxy_read_timeout 600s;
    proxy_connect_timeout 600s;
    proxy_send_timeout 600s;
  }
}

server {
  listen 80;
  server_name ai.intern;
  return 301 https://$host$request_uri;
}
