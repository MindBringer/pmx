<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üß† AI Prompt Interface</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;padding:20px;display:flex;align-items:center;justify-content:center
    }
    .container{
      background:rgba(255,255,255,.96);
      border-radius:20px;
      box-shadow:0 20px 40px rgba(0,0,0,.12);
      padding:24px;max-width:980px;width:100%;
      backdrop-filter:blur(10px)
    }
    h2{margin-bottom:16px;color:#2d2d2d}

    /* Tabs: volle Breite, gleich gro√üe Spalten */
    .tabs{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:10px; margin-bottom:14px
    }
    .tab{
      border:1px solid #dfe3f0;
      background:#ffffff;
      color:#2d2d2d;
      padding:12px 16px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      text-align:center;
      transition:background .15s ease,border-color .15s ease, color .15s ease
    }
    .tab:hover{background:#f6f8ff}
    .tab.active{
      border-color:#667eea;
      background:#eef1ff;
      color:#334;
    }

    .panel{display:none}
    .panel.active{display:block}

    .form-group{margin-bottom:12px}
    label{display:block;font-weight:600;margin-bottom:6px;color:#333}
    input[type="text"],input[type="password"],textarea,select{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid #ddd;background:#fff;color:#222
    }
    textarea{min-height:120px;resize:vertical}
    button{
      background:#667eea;color:#fff;border:none;border-radius:10px;
      padding:12px 16px;font-weight:700;cursor:pointer;width:100%
    }
    button.secondary{
      background:#f3f4ff;color:#333;border:1px solid #e0e0e0
    }
    button[disabled]{opacity:.55;cursor:not-allowed}

    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 300px}

    .result-box,.upload-box{
      margin-top:12px;border:1px solid #e0e0e0;border-radius:12px;padding:12px;background:#fff
    }
    .loading-container{
      display:flex;align-items:center;justify-content:center;gap:10px;margin-top:10px;min-height:40px
    }
    .spinner{width:18px;height:18px;border:2px solid #e0e0e0;border-top-color:#667eea;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-text{color:#667eea;font-size:16px;font-weight:600}
    .dots{display:inline-block;width:20px;text-align:left}
    .dots::after{content:'';animation:dots 1.5s steps(4,end) infinite}
    @keyframes dots{0%{content:''}25%{content:'.'}50%{content:'..'}75%{content:'...'}100%{content:''}}

    .error{color:#721c24;background:#f8d7da;border-color:#f5c6cb}
    .success{background:#d1ecf1;border-color:#bee5eb}
    .inline-help{font-size:12px;color:#666;margin-top:6px}
    .choices{display:flex;gap:12px}
    .choice{padding:8px 12px;border:2px solid #e0e0e0;border-radius:999px;cursor:pointer;user-select:none}
    .choice input{display:none}
    .choice.active{border-color:#667eea;background:#eef1ff}

    /* Segments timeline */
    .timeline{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .seg{background:#f6f8ff;border:1px solid #e0e3ff;border-radius:10px;padding:8px}
    .seg b{color:#4a5bff}

    /* Buttons in Columns (optional auf gro√üen Screens) */
    .btn-grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width: 780px){
      .btn-grid.cols-2{grid-template-columns:1fr 1fr}
      .btn-grid.cols-3{grid-template-columns:1fr 1fr 1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üß† AI Prompt Interface</h2>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-target="tab-prompt">Fragen</button>
      <button class="tab" data-target="tab-docs">Dateien</button>
    </div>

    <!-- Panel: Prompt -->
    <div class="panel active" id="tab-prompt">
      <form id="prompt-form">
        <div class="form-group">
          <label for="model">Modell:</label>
          <select id="model">
            <option value="llama3">llama3</option>
            <option value="mistral">mistral</option>
            <option value="mistralapi">Codestral API</option>
            <option value="groq">Groq API</option>
            <option value="openrouter">OpenRouter API</option>
            <option value="openai">OpenAI API</option>
            <option value="huggingface">Hugging Face API</option>
            <option value="anthropic">Anthropic API</option>
          </select>
        </div>

        <div class="form-group">
          <label for="prompt">Frage / Prompt:</label>
          <textarea id="prompt" placeholder="Stell eine Frage an das Modell..."></textarea>
        </div>

        <div class="form-group">
          <label for="system">Anweisungen f√ºr Systemverhalten (optional):</label>
          <textarea id="system" placeholder="sei ein hilfsbereiter Spezialist f√ºr..."></textarea>
        </div>

        <div class="form-group">
          <label>Firmendaten mit einbeziehen?</label>
          <div class="choices" id="rag-choices">
            <label class="choice active"><input type="radio" name="rag" value="false" checked> Nein</label>
            <label class="choice"><input type="radio" name="rag" value="true"> Ja</label>
          </div>
          <div class="inline-help">Wenn ‚ÄûJa‚Äú, wird <code>rag=true</code> an <code>/webhook/llm</code> √ºbergeben.</div>
        </div>

        <div class="btn-grid">
          <button type="submit" id="submit-btn">Senden</button>
        </div>
      </form>

      <div id="result" class="result-box">
        <div id="result-output"></div>
        <div class="loading-container" id="spinner" style="display:none">
          <div class="spinner"></div>
          <div class="loading-text">Ich arbeite<span class="dots"></span></div>
        </div>
      </div>
    </div>

    <!-- Panel: Dateien -->
    <div class="panel" id="tab-docs">
      <form id="docs-form">
        <div class="form-group">
          <label for="apiKey">API-Key (RAG)</label>
          <div class="row" style="gap:8px;align-items:center">
            <input type="password" id="apiKey" placeholder="x-api-key f√ºr RAG-Backend (z. B. change-me)" class="col" />
            <button type="button" id="toggleKey" class="secondary" style="flex:0 0 auto">anzeigen</button>
          </div>
          <div class="inline-help">Wird in <code>localStorage</code> gespeichert.</div>
        </div>

        <div class="row">
          <div class="form-group col">
            <label for="file">Datei ausw√§hlen</label>
            <input type="file" id="file" />
            <div class="inline-help">Unterst√ºtzt: txt, md, pdf, html, docx, odt, xlsx, eml</div>
          </div>
          <div class="form-group col">
            <label for="tags">Tags</label>
            <input type="text" id="tags" placeholder="z. B. projektX,angebot,intern" />
            <div class="inline-help">(optional, Komma-getrennt)</div>
          </div>
        </div>

        <div class="btn-grid cols-2">
          <button type="submit" id="upload-btn">Hochladen</button>
        </div>
      </form>

      <div id="upload-result" class="upload-box">
        <div id="upload-output"></div>
        <div class="loading-container" id="upload-spinner" style="display:none">
          <div class="spinner"></div>
          <div class="loading-text">Lade hoch<span class="dots"></span></div>
        </div>
      </div>

      <!-- --- Audio Upload (Transkription & Diarization) --- -->
      <div style="height:1px;background:#eee;margin:18px 0"></div>
      <form id="audio-form">
        <div class="form-group">
          <label for="audioFile">Audio ausw√§hlen</label>
          <input type="file" id="audioFile" accept="audio/*" />
          <div class="inline-help">Unterst√ºtzt: wav, mp3, m4a, ogg, webm, flac</div>
        </div>

        <div class="row">
          <div class="form-group col">
            <label><input type="checkbox" id="doDiar" checked/> Sprecher trennen (Diarization)</label>
            <div class="inline-help">Segmentiert Sprecher unabh√§ngig von Namen.</div>
          </div>
          <div class="form-group col">
            <label><input type="checkbox" id="doIdentify" checked/> Personen identifizieren</label>
            <div class="inline-help">Versucht bekannte Personen per Qdrant-Enrollment zuzuordnen.</div>
          </div>
        </div>

        <div class="form-group">
          <label for="speakerHints">Speaker Hints (optional)</label>
          <input type="text" id="speakerHints" placeholder="alice,bob" />
          <div class="inline-help">Bevorzugte Kandidaten (Komma-getrennt).</div>
        </div>

        <div class="form-group">
          <label for="audioTags">Tags</label>
          <input type="text" id="audioTags" placeholder="z. B. meeting,vertrieb,2025-08-14" />
          <div class="inline-help">(optional, Komma-getrennt; wird an die Transkription geh√§ngt)</div>
        </div>

        <div class="btn-grid cols-2">
          <button type="submit" id="audio-upload-btn">Audio hochladen & transkribieren</button>
        </div>
      </form>

      <div id="audio-upload-result" class="upload-box">
        <div id="audio-upload-output"></div>
        <div id="audio-segments" class="timeline"></div>
        <div class="loading-container" id="audio-upload-spinner" style="display:none">
          <div class="spinner"></div>
          <div class="loading-text">Transkribiere<span class="dots"></span></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tabs
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.target).classList.add('active');
      });
    });

    // API-Key persist + toggle
    const apiKeyInput = document.getElementById('apiKey');
    const toggleKeyBtn = document.getElementById('toggleKey');
    const savedKey = localStorage.getItem('ragApiKey');
    if (savedKey) apiKeyInput.value = savedKey;
    apiKeyInput.addEventListener('input', () => {
      localStorage.setItem('ragApiKey', apiKeyInput.value.trim());
    });
    toggleKeyBtn.addEventListener('click', () => {
      const hidden = apiKeyInput.type === 'password';
      apiKeyInput.type = hidden ? 'text' : 'password';
      toggleKeyBtn.textContent = hidden ? 'verbergen' : 'anzeigen';
    });

    // Radio pill styling
    const ragChoices = document.getElementById('rag-choices');
    ragChoices.addEventListener('change', () => {
      ragChoices.querySelectorAll('.choice').forEach(c => c.classList.remove('active'));
      const sel = ragChoices.querySelector('input[name="rag"]:checked');
      sel?.parentElement?.classList.add('active');
    });

    // Spinner helper
    function showFor(el, minMs=300){
      el.style.display = 'flex';
      const t0 = Date.now();
      return ()=>{ const dt = Date.now()-t0; const rest = Math.max(0, minMs-dt); setTimeout(()=>{ el.style.display='none'; }, rest); }
    }

    function fmtTime(sec){const h=String(Math.floor(sec/3600)).padStart(2,"0");const m=String(Math.floor((sec%3600)/60)).padStart(2,"0");const s=(sec%60).toFixed(1).padStart(4,"0");return `${h}:${m}:${s}`;}
    function escapeHtml(str){
      return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    // ---------- Prompt senden ----------
    const form = document.getElementById("prompt-form");
    const resultDiv = document.getElementById("result");
    const resultOut = document.getElementById("result-output");
    const spinner = document.getElementById("spinner");
    const submitBtn = document.getElementById("submit-btn");

    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      const prompt = document.getElementById("prompt").value.trim();
      const model = document.getElementById("model").value;
      const system = document.getElementById("system").value.trim();
      const ragVal = document.querySelector('input[name="rag"]:checked')?.value === "true";

      if (!prompt) {
        resultOut.textContent = "‚ö†Ô∏è Bitte gib einen Prompt ein.";
        resultDiv.className = "error";
        return;
      }

      resultOut.innerHTML = "";
      resultDiv.className = "";
      const hideSpinner = showFor(spinner, 300);
      submitBtn.disabled = true;

      try {
        const response = await fetch("/webhook/llm", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt, system, model, rag: ragVal })
        });
        const text = await response.text();
        if (!response.ok) throw new Error(text || `Fehler ${response.status}`);

        let data; try { data = JSON.parse(text); } catch { data = { raw: text }; }

        const answer =
          data?.answer ??
          data?.raw_response?.response ??
          data?.result ??
          (typeof data === "string" ? data : "");

        const sources = data?.sources ?? data?.documents ?? [];
        let html = "";
        if (answer) {
          html += `<div>‚úÖ Fertig ‚Äì Antwort:</div>`;
          html += `<div style="margin-top:6px">${escapeHtml(String(answer))}</div>`;
        } else {
          html += `<div>‚úÖ Fertig ‚Äì Antwort erhalten.</div>`;
          if (data?.raw) html += `<pre style="margin-top:6px">${escapeHtml(String(data.raw))}</pre>`;
        }
        if (Array.isArray(sources) && sources.length){
          html += `<div class="inline-help" style="margin-top:8px">Quellen:</div>`;
          html += `<ul style="margin:6px 0 0 18px">` + sources.map(s=>`<li>${escapeHtml(String(s.title||s.name||s))}</li>`).join("") + `</ul>`;
        }
        resultOut.innerHTML = html;
        resultDiv.className = "success";
      } catch (err) {
        resultOut.textContent = `‚ùå Fehler: ${err.message}`;
        resultDiv.className = "error";
      } finally {
        hideSpinner();
        submitBtn.disabled = false;
      }
    });

    // ---------- Dokumente indexieren ----------
    const docsForm = document.getElementById("docs-form");
    const uploadRes = document.getElementById("upload-result");
    const uploadOut = document.getElementById("upload-output");
    const uploadSpinner = document.getElementById("upload-spinner");
    const uploadBtn = document.getElementById("upload-btn");

    docsForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      const apiKey = document.getElementById("apiKey").value.trim();
      const fileEl = document.getElementById("file");
      const tagsStr = document.getElementById("tags").value.trim();

      if (!apiKey) { uploadOut.textContent = "‚ö†Ô∏è Bitte API-Key eintragen."; uploadRes.className = "error"; return; }
      if (!fileEl.files || fileEl.files.length === 0) { uploadOut.textContent = "‚ö†Ô∏è Bitte eine Datei ausw√§hlen."; uploadRes.className = "error"; return; }

      uploadOut.innerHTML = ""; uploadRes.className = "";
      const hideSpinner = showFor(uploadSpinner, 300);
      uploadBtn.disabled = true;

      try {
        const fd = new FormData();
        fd.append("files", fileEl.files[0]); // Backend erwartet "files"
        if (tagsStr) {
          tagsStr.split(",").map(t=>t.trim()).filter(Boolean).forEach(t => fd.append("tags", t));
        }

        const resp = await fetch("/rag/index", {
          method: "POST",
          headers: { "x-api-key": apiKey }, // kein Content-Type setzen!
          body: fd
        });

        const txt = await resp.text();
        if (!resp.ok) throw new Error(txt || `Fehler ${resp.status}`);

        let data; try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
        const indexed = data?.indexed || data?.files || [];
        const tags = data?.tags || [];
        let html = "";
        if (indexed.length) {
          html += `<div>‚úÖ Index erstellt:</div>`;
          html += `<ul style="margin:6px 0 0 18px">` + indexed.map(x=>`<li>${escapeHtml(String(x))}</li>`).join("") + `</ul>`;
        } else {
          html += `<div>‚úÖ Fertig ‚Äì Antwort erhalten.</div>`;
          if (data?.raw) html += `<pre style="margin-top:6px">${escapeHtml(String(data.raw))}</pre>`;
        }
        if (tags.length) {
          html += `<div class="inline-help" style="margin-top:6px">Tags: ${tags.map(escapeHtml).join(", ")}</div>`;
        }
        uploadOut.innerHTML = html;
        uploadRes.className = "success";
      } catch (err) {
        uploadOut.textContent = `‚ùå Fehler: ${err.message}`;
        uploadRes.className = "error";
      } finally {
        hideSpinner();
        uploadBtn.disabled = false;
      }
    });

    // ---------- Audio Upload (Transkription) ----------
    const audioForm    = document.getElementById("audio-form");
    const audioRes     = document.getElementById("audio-upload-result");
    const audioOut     = document.getElementById("audio-upload-output");
    const audioSpinner = document.getElementById("audio-upload-spinner");
    const audioBtn     = document.getElementById("audio-upload-btn");

    if (audioForm) {
      audioForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        const apiKey = document.getElementById("apiKey").value.trim();
        const fileEl = document.getElementById("audioFile");
        const tagsStr = document.getElementById("audioTags").value.trim();

        if (!apiKey) { audioOut.textContent = "‚ö†Ô∏è Bitte API-Key eintragen."; audioRes.className = "error"; return; }
        if (!fileEl.files || fileEl.files.length === 0) { audioOut.textContent = "‚ö†Ô∏è Bitte eine Audio-Datei ausw√§hlen."; audioRes.className = "error"; return; }

        audioOut.innerHTML = ""; audioRes.className = "";
        const hideSpinner = showFor(audioSpinner, 300);
        audioBtn.disabled = true;

        try {
          const fd = new FormData();
          fd.append("file", fileEl.files[0]); // Transcribe erwartet "file"
          if (tagsStr) {
            tagsStr.split(",").map(t=>t.trim()).filter(Boolean).forEach(t => fd.append("tags", t));
          }
          const doDiar = document.getElementById("doDiar");
          const doIdentify = document.getElementById("doIdentify");
          const hints = document.getElementById("speakerHints");
          if (doDiar) fd.append("diarize_flag", doDiar.checked ? "true":"false");
          if (doIdentify) fd.append("identify", doIdentify.checked ? "true":"false");
          if (hints && hints.value.trim()) fd.append("speaker_hints", hints.value.trim());

          const resp = await fetch("/rag/transcribe", {
            method: "POST",
            headers: { "x-api-key": apiKey },
            body: fd
          });

          const txt = await resp.text();
          if (!resp.ok) throw new Error(txt || `Fehler ${resp.status}`);

          let data; try { data = JSON.parse(txt); } catch { data = { raw: txt }; }

          const segments = Array.isArray(data?.segments) ? data.segments : null;
          const transcript =
            data?.text ??
            data?.transcript ??
            data?.transcription ??
            data?.result ??
            (typeof data === "string" ? data : "");

          const usedTags = data?.used_tags || data?.tags || [];
          const lang = data?.language || data?.lang;
          const dur  = data?.duration || data?.audio_duration;
          const model = data?.model || data?.whisper_model;

          let html = "";
          if (transcript) {
            html += `<div>‚úÖ Fertig ‚Äì Transkript:</div>`;
            html += `<pre style="margin-top:6px;max-height:260px;overflow:auto">${escapeHtml(String(transcript))}</pre>`;
          } else {
            html += `<div>‚úÖ Fertig ‚Äì Antwort erhalten.</div>`;
            if (data?.raw) html += `<pre style="margin-top:6px">${escapeHtml(String(data.raw))}</pre>`;
          }

          if (segments && segments.length){
            html += `<div style="margin-top:10px;font-weight:700">Segmente</div>`;
            html += `<div class="timeline">` + segments.map(s => {
              const who = s.name || s.speaker || "spk";
              const t0 = fmtTime(s.start||0), t1 = fmtTime(s.end||0);
              return `<div class="seg"><b>${escapeHtml(String(who))}</b> <span class="inline-help">[${t0}‚Äì${t1}]</span><div>${escapeHtml(String(s.text||""))}</div></div>`;
            }).join("") + `</div>`;
          }

          const metaBits = [];
          if (lang)  metaBits.push(`Sprache: ${escapeHtml(String(lang))}`);
          if (dur)   metaBits.push(`Dauer: ${escapeHtml(String(dur))}`);
          if (model) metaBits.push(`Modell: ${escapeHtml(String(model))}`);
          if (metaBits.length) {
            html += `<div class="inline-help" style="margin-top:6px">${metaBits.join(" ¬∑ ")}</div>`;
          }

          if (Array.isArray(usedTags) && usedTags.length) {
            html += `<div class="inline-help" style="margin-top:6px">Tags: ${usedTags.map(escapeHtml).join(", ")}</div>`;
          }

          audioOut.innerHTML = html;
          audioRes.className = "success";
        } catch (err) {
          audioOut.textContent = `‚ùå Transkription fehlgeschlagen: ${err.message}`;
          audioRes.className = "error";
        } finally {
          hideSpinner();
          audioBtn.disabled = false;
        }
      });
    }
  </script>
</body>
</html>
