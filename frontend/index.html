<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ðŸ§  AI Prompt Interface</title>
  <style>
    :root{
      --g1:#667eea;
      --g2:#764ba2;
      --bg-card:#ffffff;
      --bd:#e0e0e0;
      --ink:#2d2d2d;
      --ink-muted:#666;
      --ok:#1e8e5a;
      --err:#b42318;
      --shadow-sm: 0 4px 12px rgba(0,0,0,.12);
      --shadow-md: 0 10px 24px rgba(0,0,0,.18);
      --shadow-lg: 0 16px 40px rgba(0,0,0,.22);
      --grad: linear-gradient(135deg,var(--g1) 0%,var(--g2) 100%);
    }

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono","Courier New", monospace}
    pre.prewrap{white-space:pre-wrap;word-wrap:break-word;overflow:auto;max-height:none}

    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
      background:var(--grad);
      min-height:100vh;padding:20px;display:flex;align-items:center;justify-content:center
    }
    .container{
      background:rgba(255,255,255,.96);
      border-radius:20px;
      box-shadow:var(--shadow-md);
      padding:24px;max-width:980px;width:100%;
      backdrop-filter:blur(10px)
    }
    h2{margin-bottom:16px;color:var(--ink)}

    /* Tabs: volle Breite, gleich groÃŸe Spalten */
    .tabs{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:10px; margin-bottom:14px
    }
    .tab{
      border:1px solid #dfe3f0;
      background:#ffffff;
      color:var(--ink);
      padding:12px 16px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      text-align:center;
      transition:background .15s ease,border-color .15s ease,color .15s ease, box-shadow .2s ease, transform .2s ease
    }
    .tab:hover{
      background:#f6f8ff;
      box-shadow:var(--shadow-sm);
      transform:translateY(-1px);
    }
    .tab.active{
      background:var(--grad);
      color:#fff;
      border-color:transparent;
      box-shadow:0 6px 18px rgba(118,75,162,.25), 0 4px 12px rgba(102,126,234,.22);
    }
    .tab.active:hover {
      box-shadow: var(--shadow-lg);
      filter: brightness(1.03);
    }

    .panel{display:none}
    .panel.active{display:block}

    /* Sub-Tabs inside Prompt */
    .subtab-bar{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:8px 0 12px}
    .subtab{width:100%;text-align:center;border:1px solid #dfe3f0;background:#fff;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .subtab.active{background:var(--grad);color:#fff;border-color:transparent}
    .subpanel{display:none}
    .subpanel.active{display:block}
    .persona-row{border:1px solid var(--bd);border-radius:12px;padding:10px;margin-bottom:10px;background:#fff}
    .persona-head{display:block;font-weight:700;margin-bottom:6px}

    .form-group{margin-bottom:12px}
    label{display:block;font-weight:600;margin-bottom:6px;color:#333}
    input[type="text"],input[type="password"],textarea,select,input[type="number"]{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--bd);background:#fff;color:#222;
      transition: box-shadow .2s ease, border-color .15s ease
    }
    input[type="text"]:hover,input[type="password"]:hover,textarea:hover,select:hover,input[type="number"]:hover{
      box-shadow:var(--shadow-sm);
    }
    input[type="text"]:focus,input[type="password"]:focus,textarea:focus,select:focus,input[type="number"]:focus{
      outline:none;border-color:#b9c1ff;box-shadow:0 0 0 3px rgba(102,126,234,.18);
    }
    textarea{min-height:120px;resize:vertical}

    /* Buttons: Verlauf + Hover-Lift */
    button{
      background:var(--grad);
      color:#fff;border:none;border-radius:12px;
      padding:12px 16px;font-weight:800;cursor:pointer;width:100%;
      box-shadow:0 6px 18px rgba(118,75,162,.25), 0 4px 12px rgba(102,126,234,.22);
      transition: box-shadow .2s ease, transform .2s ease, filter .2s ease
    }
    button:hover{
      box-shadow:var(--shadow-lg);
      transform: translateY(-1px);
      filter: brightness(1.02);
    }
    button:active{
      transform: translateY(0);
      box-shadow:var(--shadow-md);
    }
    button.secondary{
      background:#f3f4ff;color:#333;border:1px solid #e0e0e0;box-shadow:var(--shadow-sm)
    }
    button.secondary:hover{transform:translateY(-1px)}

    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 300px}

    .result-box,.upload-box{
      margin-top:12px;border:1px solid var(--bd);border-radius:12px;padding:12px;background:#fff;
      transition: box-shadow .2s ease, transform .2s ease
    }
    .result-box:hover,.upload-box:hover{
      box-shadow:var(--shadow-sm);
      transform: translateY(-1px);
    }

    .loading-container{
      display:flex;align-items:center;justify-content:center;gap:10px;margin-top:10px;min-height:40px
    }
    .spinner{width:18px;height:18px;border:2px solid #e0e0e0;border-top-color:#667eea;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-text{color:#667eea;font-size:16px;font-weight:600}
    .dots{display:inline-block;width:20px;text-align:left}
    .dots::after{content:'';animation:dots 1.5s steps(4,end) infinite}
    @keyframes dots{0%{content:''}25%{content:'.'}50%{content:'..'}75%{content:'...'}100%{content:''}}

    .error{color:#721c24;background:#f8d7da;border-color:#f5c6cb}
    .success{background:#d1ecf1;border-color:#bee5eb}
    .inline-help{font-size:12px;color:var(--ink-muted);margin-top:6px}
    .choices{display:flex;gap:12px}
    .choice{padding:8px 12px;border:2px solid #e0e0e0;border-radius:999px;cursor:pointer;user-select:none;transition: box-shadow .2s ease, transform .2s ease}
    .choice input{display:none}
    .choice:hover{box-shadow:var(--shadow-sm);transform: translateY(-1px)}
    .choice.active{border-color:#667eea;background:#eef1ff}

    /* Segments timeline */
    .timeline{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .seg{background:#f6f8ff;border:1px solid #e0e3ff;border-radius:10px;padding:8px}
    .seg b{color:#4a5bff}

    /* Level meter */
    .meter{height:8px;background:#eef1ff;border:1px solid #e0e3ff;border-radius:999px;overflow:hidden}
    .meter > i{display:block;height:100%;width:0%;background:var(--g1);transition:width .08s linear}

    /* Buttons in Columns */
    .btn-grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width: 780px){
      .btn-grid.cols-2{grid-template-columns:1fr 1fr}
      .btn-grid.cols-3{grid-template-columns:1fr 1fr 1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ðŸ§  AI Prompt Interface</h2>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-target="tab-prompt">Fragen</button>
      <button class="tab" data-target="tab-docs">Dateien</button>
    </div>

    <!-- Panel: Prompt -->
    <div class="panel active" id="tab-prompt">
      <form id="prompt-form">
        <div class="form-group">
          <label for="prompt">Frage / Prompt:</label>
          <textarea id="prompt" placeholder="Stell eine Frage an das Modell..."></textarea>
        </div>

        <!-- Unterbereich: Anweisungen mit Sub-Tabs -->
        <div class="subtabs">
          <div class="subtab-bar">
            <button type="button" class="subtab active" data-target="subtab-sys">Systemverhalten</button>
            <button type="button" class="subtab" data-target="subtab-agents">Agenten/Personas</button>
          </div>

          <!-- Systemverhalten -->
          <div class="subpanel active" id="subtab-sys">
            <div class="form-group">
              <label for="model_sys">Modell:</label>
              <select id="model_sys">
                <option value="llama3">llama3</option>
                <option value="mistral">mistral</option>
                <option value="mistralapi">Codestral API</option>
                <option value="groq">Groq API</option>
                <option value="openrouter">OpenRouter API</option>
                <option value="openai">OpenAI API</option>
                <option value="huggingface">Hugging Face API</option>
                <option value="anthropic">Anthropic API</option>
              </select>
            </div>

            <div class="form-group">
              <label for="system">Anweisungen fÃ¼r Systemverhalten (optional):</label>
              <textarea id="system" placeholder="sei ein hilfsbereiter Spezialist fÃ¼r..."></textarea>
            </div>
          </div>

          <!-- Agenten/Personas -->
          <div class="subpanel" id="subtab-agents">
            <div class="inline-help" style="margin:6px 0 12px">
              Aktiviere bis zu 5 Personas. Leere Felder werden ignoriert. Beispiel-Rollen helfen beim Start.
            </div>

            <!-- Ablauf: Runden -->
            <div class="persona-row" style="margin-top:10px">
              <span class="persona-head">Ablauf</span>
              <div class="row">
                <div class="form-group col" style="max-width:220px">
                  <label for="agent_rounds">Anzahl Runden</label>
                  <input type="number" id="agent_rounds" min="1" max="10" step="1" value="1"/>
                  <div class="inline-help">Wie viele DurchlÃ¤ufe die Personas diskutieren (1â€“10).</div>
                </div>
              </div>
            </div>

            <!-- Facilitator / Critic Auswahl -->
            <div class="persona-row">
              <span class="persona-head">Facilitator / Critic</span>
              <div class="row">
                <div class="form-group col">
                  <label for="critic_provider">Provider</label>
                  <select id="critic_provider">
                    <option value="">(Standard)</option>
                    <option value="groq">Groq API</option>
                    <option value="openai">OpenAI API</option>
                    <option value="anthropic">Anthropic API</option>
                    <option value="mistralapi">Codestral API</option>
                    <option value="openrouter">OpenRouter API</option>
                    <option value="huggingface">Hugging Face API</option>
                    <option value="mistral">mistral</option>
                    <option value="llama3">llama3</option>
                  </select>
                </div>
                <div class="form-group col">
                  <label for="critic_model">Modell</label>
                  <input type="text" id="critic_model" placeholder="z. B. claude-3-5-sonnet oder llama-3.1-70b-versatile"/>
                  <div class="inline-help">Optional, wird je Provider automatisch gemappt.</div>
                </div>
              </div>
            </div>

            <!-- Writer Auswahl -->
            <div class="persona-row">
              <span class="persona-head">Writer</span>
              <div class="row">
                <div class="form-group col">
                  <label for="writer_provider">Provider</label>
                  <select id="writer_provider">
                    <option value="">(Standard)</option>
                    <option value="groq">Groq API</option>
                    <option value="openai">OpenAI API</option>
                    <option value="anthropic">Anthropic API</option>
                    <option value="mistralapi">Codestral API</option>
                    <option value="openrouter">OpenRouter API</option>
                    <option value="huggingface">Hugging Face API</option>
                    <option value="mistral">mistral</option>
                    <option value="llama3">llama3</option>
                  </select>
                </div>
                <div class="form-group col">
                  <label for="writer_model">Modell</label>
                  <input type="text" id="writer_model" placeholder="z. B. gpt-4o-mini oder llama-3.1-70b-versatile"/>
                  <div class="inline-help">Optional, wird je Provider automatisch gemappt.</div>
                </div>
              </div>
            </div>

            <!-- Persona Row Template repeated 5x -->
            <div class="persona-row">
              <label class="persona-head"><input type="checkbox" id="p1_enabled" /> Persona 1</label>
              <div class="row">
                <div class="form-group col">
                  <label for="p1_label">Jobtitel / Beschreibung</label>
                  <input type="text" id="p1_label" placeholder="z. B. Buchhalter â€“ Kosten & Risiken prÃ¼fen" />
                </div>
                <div class="form-group col">
                  <label for="p1_model">Modell</label>
                  <select id="p1_model">
                    <option value="groq">Groq API</option>
                    <option value="mistralapi">Codestral API</option>
                    <option value="openrouter">OpenRouter API</option>
                    <option value="llama3">llama3</option>
                    <option value="mistral">mistral</option>
                    <option value="openai">OpenAI API</option>
                    <option value="huggingface">Hugging Face API</option>
                    <option value="anthropic">Anthropic API</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="persona-row">
              <label class="persona-head"><input type="checkbox" id="p2_enabled" /> Persona 2</label>
              <div class="row">
                <div class="form-group col">
                  <label for="p2_label">Jobtitel / Beschreibung</label>
                  <input type="text" id="p2_label" placeholder="z. B. IT-Spezialist â€“ Architektur & Aufwand" />
                </div>
                <div class="form-group col">
                  <label for="p2_model">Modell</label>
                  <select id="p2_model">
                    <option value="mistralapi">Codestral API</option>
                    <option value="groq">Groq API</option>
                    <option value="openrouter">OpenRouter API</option>
                    <option value="llama3">llama3</option>
                    <option value="mistral">mistral</option>
                    <option value="openai">OpenAI API</option>
                    <option value="huggingface">Hugging Face API</option>
                    <option value="anthropic">Anthropic API</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="persona-row">
              <label class="persona-head"><input type="checkbox" id="p3_enabled" /> Persona 3</label>
              <div class="row">
                <div class="form-group col">
                  <label for="p3_label">Jobtitel / Beschreibung</label>
                  <input type="text" id="p3_label" placeholder="z. B. Vertrieb â€“ Kundennutzen & Upsell" />
                </div>
                <div class="form-group col">
                  <label for="p3_model">Modell</label>
                  <select id="p3_model">
                    <option value="openrouter">OpenRouter API</option>
                    <option value="groq">Groq API</option>
                    <option value="mistralapi">Codestral API</option>
                    <option value="llama3">llama3</option>
                    <option value="mistral">mistral</option>
                    <option value="openai">OpenAI API</option>
                    <option value="huggingface">Hugging Face API</option>
                    <option value="anthropic">Anthropic API</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="persona-row">
              <label class="persona-head"><input type="checkbox" id="p4_enabled" /> Persona 4</label>
              <div class="row">
                <div class="form-group col">
                  <label for="p4_label">Jobtitel / Beschreibung</label>
                  <input type="text" id="p4_label" placeholder="z. B. Recht â€“ Compliance & DSGVO" />
                </div>
                <div class="form-group col">
                  <label for="p4_model">Modell</label>
                  <select id="p4_model">
                    <option value="anthropic">Anthropic API</option>
                    <option value="openai">OpenAI API</option>
                    <option value="groq">Groq API</option>
                    <option value="mistralapi">Codestral API</option>
                    <option value="llama3">llama3</option>
                    <option value="mistral">mistral</option>
                    <option value="huggingface">Hugging Face API</option>
                    <option value="openrouter">OpenRouter API</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="persona-row">
              <label class="persona-head"><input type="checkbox" id="p5_enabled" /> Persona 5</label>
              <div class="row">
                <div class="form-group col">
                  <label for="p5_label">Jobtitel / Beschreibung</label>
                  <input type="text" id="p5_label" placeholder="z. B. Einkauf â€“ Angebote & RahmenvertrÃ¤ge" />
                </div>
                <div class="form-group col">
                  <label for="p5_model">Modell</label>
                  <select id="p5_model">
                    <option value="huggingface">Hugging Face API</option>
                    <option value="llama3">llama3</option>
                    <option value="mistral">mistral</option>
                    <option value="mistralapi">Codestral API</option>
                    <option value="groq">Groq API</option>
                    <option value="openrouter">OpenRouter API</option>
                    <option value="openai">OpenAI API</option>
                    <option value="anthropic">Anthropic API</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Firmendaten mit einbeziehen?</label>
          <div class="choices" id="rag-choices">
            <label class="choice active"><input type="radio" name="rag" value="false" checked> Nein</label>
            <label class="choice"><input type="radio" name="rag" value="true"> Ja</label>
          </div>
          <div class="inline-help">Wenn â€žJaâ€œ, wird <code>rag=true</code> an <code>/webhook/llm</code> Ã¼bergeben.</div>
        </div>

        <div class="btn-grid">
          <button type="submit" id="submit-btn">Senden</button>
        </div>
        <div id="conv-status" class="inline-help" style="margin:8px 0"></div>
      </form>

      <!-- Live-Status fÃ¼r Async-Jobs (SSE) -->
      <section id="job-status" class="result-box" style="display:none">
        <div style="font-weight:700;margin-bottom:6px">Live-Status</div>
        <div id="job-title" style="margin-bottom:4px;">â€”</div>
        <div id="job-statusline" style="margin-bottom:8px;">Warte auf Start â€¦</div>
        <div id="job-log" class="mono" style="border:1px solid #ddd; padding:8px; max-height:240px; overflow:auto; background:#fafafa; font-size: 12px;"></div>
      </section>

      <div id="result" class="result-box">
        <div id="result-output"></div>
        <div class="loading-container" id="spinner" style="display:none">
          <div class="spinner"></div>
          <div class="loading-text">Ich arbeite<span class="dots"></span></div>
        </div>
      </div>
    </div>

    <!-- Panel: Dateien -->
    <div class="panel" id="tab-docs">
      <form id="docs-form">
        <div class="form-group">
          <label for="apiKey">API-Key (RAG)</label>
          <div class="row" style="gap:8px;align-items:center">
            <input type="password" id="apiKey" placeholder="x-api-key fÃ¼r RAG-Backend (z. B. change-me)" class="col" />
            <button type="button" id="toggleKey" class="secondary" style="flex:0 0 auto">anzeigen</button>
          </div>
          <div class="inline-help">Wird in <code>localStorage</code> gespeichert.</div>
        </div>

        <div class="row">
          <div class="form-group col">
            <label for="file">Datei auswÃ¤hlen</label>
            <input type="file" id="file" multiple />
            <div class="inline-help">UnterstÃ¼tzt: txt, md, pdf, html, docx, odt, xlsx, eml</div>
          </div>
          <div class="form-group col">
            <label for="tags">Tags</label>
            <input type="text" id="tags" placeholder="z. B. projektX,angebot,intern" />
            <div class="inline-help">(optional, Komma-getrennt)</div>
          </div>
        </div>

        <div class="btn-grid cols-2">
          <button type="submit" id="upload-btn">Hochladen</button>
        </div>
      </form>

      <div id="upload-result" class="upload-box">
        <div id="upload-output"></div>
        <div class="loading-container" id="upload-spinner" style="display:none">
          <div class="spinner"></div>
          <div class="loading-text">Lade hoch<span class="dots"></span></div>
        </div>
      </div>

      <!-- --- Audio Upload (Transkription & Diarization) --- -->
      <div style="height:1px;background:#eee;margin:18px 0"></div>
      <form id="audio-form">
        <div class="form-group">
          <label for="audioFile">Audio auswÃ¤hlen</label>
          <input type="file" id="audioFile" accept="audio/*" />
          <div class="inline-help">UnterstÃ¼tzt: wav, mp3, m4a, ogg, webm, flac</div>
        </div>

        <!-- Mic controls (Transcribe) -->
        <div class="row">
          <div class="form-group col">
            <label>Mikrofon</label>
            <select id="micSelectTrans"></select>
            <div class="inline-help" id="micStatusTrans">â€“</div>
          </div>
          <div class="form-group col">
            <label>Aufnahme</label>
            <div class="btn-grid cols-2">
              <button type="button" id="micCheckTrans" class="secondary">Hardware prÃ¼fen</button>
              <button type="button" id="micStartTrans">Aufnehmen</button>
              <button type="button" id="micStopTrans" class="secondary" disabled>Stop</button>
            </div>
            <div class="inline-help">
              <span id="micTimerTrans">00:00</span>
            </div>
            <div class="meter"><i id="micMeterTrans"></i></div>
          </div>
        </div>

        <div class="row">
          <div class="form-group col">
            <label><input type="checkbox" id="doDiar" checked/> Sprecher trennen (Diarization)</label>
            <div class="inline-help">Segmentiert Sprecher unabhÃ¤ngig von Namen.</div>
          </div>
          <div class="form-group col">
            <label><input type="checkbox" id="doIdentify" checked/> Personen identifizieren</label>
            <div class="inline-help">Versucht bekannte Personen per Qdrant-Enrollment zuzuordnen.</div>
          </div>
        </div>

        <div class="form-group">
          <label for="speakerHints">Speaker Hints (optional)</label>
          <input type="text" id="speakerHints" placeholder="alice,bob" />
          <div class="inline-help">Bevorzugte Kandidaten (Komma-getrennt).</div>
        </div>

        <div class="form-group">
          <label for="audioTags">Tags</label>
          <input type="text" id="audioTags" placeholder="z. B. meeting,vertrieb,2025-08-14" />
          <div class="inline-help">(optional, Komma-getrennt; wird an die Transkription gehÃ¤ngt)</div>
        </div>

        <div class="btn-grid cols-2">
          <button type="submit" id="audio-upload-btn">Audio hochladen & transkribieren</button>
        </div>
      </form>

      <div id="audio-upload-result" class="upload-box">
        <div id="audio-upload-output"></div>
        <div id="audio-segments" class="timeline"></div>
        <div class="loading-container" id="audio-upload-spinner" style="display:none">
          <div class="spinner"></div>
          <div class="loading-text">Transkribiere<span class="dots"></span></div>
        </div>
      </div>

      <!-- --- Sprecherverwaltung (Enrollment) --- -->
      <div style="height:1px;background:#eee;margin:18px 0"></div>
      <form id="speaker-form">
        <div class="form-group">
          <label for="speakerName">Name des Sprechers</label>
          <input type="text" id="speakerName" placeholder="z. B. Alice MÃ¼ller" />
          <div class="inline-help">Nutze exakt denselben Namen, der spÃ¤ter zur Anzeige verwendet werden soll.</div>
        </div>
        <div class="form-group">
          <label for="speakerFile">Referenz-Audio fÃ¼r Enrollment</label>
          <input type="file" id="speakerFile" accept="audio/*" />
          <div class="inline-help">Empfohlen: 10â€“30 Sek. klare Sprache.</div>
        </div>

        <!-- Mic controls (Enroll) -->
        <div class="row">
          <div class="form-group col">
            <label>Mikrofon</label>
            <select id="micSelectEnroll"></select>
            <div class="inline-help" id="micStatusEnroll">â€“</div>
          </div>
          <div class="form-group col">
            <label>Aufnahme</label>
            <div class="btn-grid cols-2">
              <button type="button" id="micCheckEnroll" class="secondary">Hardware prÃ¼fen</button>
              <button type="button" id="micStartEnroll">Aufnehmen</button>
              <button type="button" id="micStopEnroll" class="secondary" disabled>Stop</button>
            </div>
            <div class="inline-help">
              <span id="micTimerEnroll">00:00</span>
            </div>
            <div class="meter"><i id="micMeterEnroll"></i></div>
          </div>
        </div>

        <div class="btn-grid cols-2">
          <button type="submit" id="speaker-enroll-btn">Sprecher hinzufÃ¼gen</button>
        </div>
      </form>

      <div id="speaker-result" class="upload-box">
        <div id="speaker-output"></div>
        <div class="loading-container" id="speaker-spinner" style="display:none">
          <div class="spinner"></div>
          <div class="loading-text">Speichere<span class="dots"></span></div>
        </div>
      </div>

      <div class="upload-box" style="margin-top:12px">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <div><b>Bekannte Sprecher</b></div>
          <button type="button" id="speaker-refresh-btn" class="secondary" style="width:auto">Liste aktualisieren</button>
        </div>
        <div id="speaker-list" class="timeline" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <script>
    // Tabs
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.target).classList.add('active');
      });
    });

    // API-Key persist + toggle
    const apiKeyInput = document.getElementById('apiKey');
    const toggleKeyBtn = document.getElementById('toggleKey');
    const savedKey = localStorage.getItem('ragApiKey');
    if (savedKey) apiKeyInput.value = savedKey;
    apiKeyInput?.addEventListener('input', () => {
      localStorage.setItem('ragApiKey', apiKeyInput.value.trim());
    });
    toggleKeyBtn?.addEventListener('click', () => {
      const hidden = apiKeyInput.type === 'password';
      apiKeyInput.type = hidden ? 'text' : 'password';
      toggleKeyBtn.textContent = hidden ? 'verbergen' : 'anzeigen';
    });

    // Radio pill styling
    const ragChoices = document.getElementById('rag-choices');
    ragChoices.addEventListener('change', () => {
      ragChoices.querySelectorAll('.choice').forEach(c => c.classList.remove('active'));
      const sel = ragChoices.querySelector('input[name="rag"]:checked');
      sel?.parentElement?.classList.add('active');
    });

    // Helpers
    function showFor(el, minMs=300){
      el.style.display = 'flex';
      const t0 = Date.now();
      return ()=>{ const dt = Date.now()-t0; const rest = Math.max(0, minMs-dt); setTimeout(()=>{ el.style.display='none'; }, rest); }
    }
    function fmtTime(sec){const h=String(Math.floor(sec/3600)).padStart(2,"0");const m=String(Math.floor((sec%3600)/60)).padStart(2,"0");const s=String(Math.floor(sec%60)).padStart(2,"0");return `${h}:${m}:${s}`;}
    function fmtMs(ms){ if(ms==null) return "â€“"; if(ms<1000) return `${Math.round(ms)} ms`; return `${(ms/1000).toFixed(2)} s`; }
    function fmtBytes(b){ if(typeof b!=="number") return "â€“"; const u=["B","KB","MB","GB","TB"]; let i=0,n=b; while(n>=1024 && i<u.length-1){ n/=1024; i++; } return `${n.toFixed(n<10?2:(n<100?1:0))} ${u[i]}`; }
    function escapeHtml(str){ return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }

    // --- Streaming-/NDJSON-/SSE-Parser (robust gegen lange Antworten) ---
    function parseNdjsonToText(s){
      const lines = String(s).split(/\r?\n/).filter(Boolean);
      let out = "";
      for(const ln of lines){
        try{
          const obj = JSON.parse(ln);
          if (obj?.response != null) out += String(obj.response);
          else if (obj?.data?.response != null) out += String(obj.data.response);
          else if (obj?.choices?.[0]?.delta?.content != null) out += String(obj.choices[0].delta.content);
        }catch{/* ignore */}
      }
      return out || null;
    }
    function parseSseToNdjson(s){
      const events = String(s).split('\n\n');
      const dataLines = events.flatMap(ev => ev.split('\n').filter(l => l.startsWith('data:')).map(l => l.slice(5).trim()));
      return dataLines.join('\n');
    }

    // ---------- Conversation state ----------
    const CONV_KEY = 'conversationId';

    function isValidConversationId(id) {
      return typeof id === 'string'
        && id.length > 0
        && id.length < 200
        && !id.includes('$json')
        && !id.includes('{{')
        && /^[A-Za-z0-9._:-]+$/.test(id); // UUID & simple tokens
    }

    let conversationId = localStorage.getItem(CONV_KEY) || null;
    if (!isValidConversationId(conversationId)) {
      conversationId = null;
      localStorage.removeItem(CONV_KEY);
    }

    function setConversationId(id) {
      if (!isValidConversationId(id)) {
        conversationId = null;
        localStorage.removeItem(CONV_KEY);
      } else {
        conversationId = id;
        localStorage.setItem(CONV_KEY, id);
      }
      renderConvStatus();
    }

    function renderConvStatus(){
      const el = document.getElementById('conv-status');
      if (!el) return;
      const idView = conversationId ? `<code>${escapeHtml(conversationId)}</code>` : `<i>neu</i>`;
      el.innerHTML = `Konversation: ${idView} ${
        conversationId ? `<button type="button" id="conv-reset" class="secondary" style="width:auto;margin-left:8px">Neue Unterhaltung</button>` : ''
      }`;
      document.getElementById('conv-reset')?.addEventListener('click', ()=> setConversationId(null));
    }
    renderConvStatus();

    // ---------- Subtabs (Anweisungen) ----------
    document.querySelectorAll('.subtab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.subtab').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.subpanel').forEach(p=>p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.target).classList.add('active');
      });
    });

    function collectPersonas(){
      const rows = [1,2,3,4,5];
      const list = [];
      for (const i of rows){
        const en = document.getElementById(`p${i}_enabled`);
        const labEl = document.getElementById(`p${i}_label`);
        const modEl = document.getElementById(`p${i}_model`);
        if (!en || !labEl || !modEl) continue;
        const checked = !!en.checked;
        const label = (labEl.value||'').trim();
        const provider = modEl.value;
        if (checked){
          if (!label){
            throw new Error(`Bitte Jobtitel/Beschreibung fÃ¼r Persona ${i} eingeben.`);
          }
          list.push({ label, provider });
        }
      }
      return list;
    }

    function activeSubtab(){
      const a = document.querySelector('.subtab.active');
      return a ? a.dataset.target : 'subtab-sys';
    }

    // ---------- Prompt senden ----------
    const form = document.getElementById("prompt-form");
    const resultDiv = document.getElementById("result");
    const resultOut = document.getElementById("result-output");
    const spinner = document.getElementById("spinner");
    const submitBtn = document.getElementById("submit-btn");

    function renderSources(sources){
      if (!Array.isArray(sources) || sources.length === 0) return "";
      const items = sources.map((s, i) => {
        if (typeof s === "string") return `<li>${escapeHtml(s)}</li>`;
        if (s && typeof s === "object") {
          const title = s.title || s.name || s.meta?.title || s.file_name || `Quelle ${i+1}`;
          const origin = s.source || s.meta?.source || "";
          const score  = (s.score != null) ? ` Â· Score: <b>${Number(s.score).toFixed(3)}</b>` : "";
          const tags   = Array.isArray(s.tags) && s.tags.length ? ` Â· Tags: ${s.tags.map(escapeHtml).join(", ")}` : "";
          const href   = s.url || s.link;
          const head   = href ? `<a href="${href}" target="_blank" rel="noopener">${escapeHtml(String(title))}</a>` : escapeHtml(String(title));
          const snippet = s.snippet || s.content || s.text || "";
          return `<li><b>${head}</b>${origin?` <span class="inline-help">(${escapeHtml(String(origin))})</span>`:""}${score}${tags}${snippet?`<div class="inline-help" style="margin-top:4px">${escapeHtml(String(snippet))}</div>`:""}</li>`;
        }
        return `<li>${escapeHtml(String(s))}</li>`;
      }).join("");
      return `<div class="inline-help" style="margin-top:8px">Quellen:</div><ul class="sources">${items}</ul>`;
    }

    // === Async Job (SSE) UI helpers ===
    const jobBox   = document.getElementById('job-status');
    const jobTitleEl = document.getElementById('job-title');
    const jobLine  = document.getElementById('job-statusline');
    const jobLog   = document.getElementById('job-log');

    function showJob(title){
      jobTitleEl.textContent = title || 'Agentenlauf';
      jobLine.textContent  = 'Gestartet â€¦';
      jobLog.innerHTML     = '';
      jobBox.style.display = 'block';
    }
    function logJob(msg){
      const div = document.createElement('div');
      div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      jobLog.appendChild(div);
      jobLog.scrollTop = jobLog.scrollHeight;
    }
    function sseLabel(jobTitle, evt){
      const parts = [];
      if (jobTitle) parts.push(jobTitle);
      if (evt.persona) parts.push(evt.persona);
      if (evt.role) parts.push('/'+evt.role);
      if (evt.round && evt.rounds_total) parts.push(` â€“ Runde ${evt.round}/${evt.rounds_total}`);
      return parts.join(' ');
    }

    async function startAsyncRun(job_title, payload){
      // 1) Starten (Webhook mit async=true)
      const headers = { "Content-Type": "application/json" };
      if (isValidConversationId(conversationId)) {
        payload.conversation_id = conversationId;
        headers["x-conversation-id"] = conversationId;
      }
      payload.async = true;
      payload.title = job_title;

      // 1) Request & robustes ACK-Parsing
      const res = await fetch("/webhook/llm", {
        method: "POST",
        headers,
        body: JSON.stringify(payload),
      });

      const ackText = await res.text();
      let ack = {};
      try { ack = JSON.parse(ackText); } catch {}
      console.debug("[ACK]", res.status, ackText);

      // 2) job_id EINMAL ermitteln (Fallback: aus events/result extrahieren)
      const jobId =
        ack.job_id ||
        (typeof ack.events === "string" && ack.events.match(/\/rag\/jobs\/([^/]+)/)?.[1]) ||
        (typeof ack.result === "string" && ack.result.match(/\/rag\/jobs\/([^/]+)/)?.[1]) ||
        "";

      if (!res.ok || !jobId) {
        throw new Error(ack?.message || ack?.error || `Start fehlgeschlagen (${res.status})`);
      }
      ack.job_id = jobId; // fÃ¼r Folge-Schritte verfÃ¼gbar machen

      showJob(job_title || payload?.prompt || "Agentenlauf");

      // 3) Hilfsfunktion nur 1x definieren
      const looksOk = (u) => {
        if (typeof u !== "string" || !u) return false;
        if (u.includes("{{") || u.includes("$json")) return false; // n8n-Platzhalter
        try {
          const url = new URL(u, location.href);
          return url.origin === location.origin && url.pathname.startsWith("/rag/jobs/");
        } catch { return false; }
      };

      // 4) SSE-URL stabil bauen (keine zweite jobId-Definition!)
      const eventsUrl = looksOk(ack.events)
        ? ack.events
        : `/rag/jobs/${encodeURIComponent(jobId)}/events`;

      // 5) EventSource Ã¶ffnen
      try { window.__es?.close(); } catch {}
      const src = new EventSource(eventsUrl, { withCredentials: true });
      window.__es = src;

      logJob(`Verbinde: ${eventsUrl}`);
      src.onopen  = () => logJob("SSE verbunden.");
      src.onerror = () => logJob("Stream-Fehler (SSE) â€“ versuche verbunden zu bleiben â€¦");
      // src.onmessage = (e) => { ... dein Handler ... };

      // (optional spÃ¤ter fÃ¼rs Ergebnis)
      const resultUrl = looksOk(ack.result)
        ? ack.result
        : `/rag/jobs/${encodeURIComponent(jobId)}/result`;

      const final = await fetch(resultUrl).then(r=>r.json());
      if (final?.status === "done"){
        const answer = final.result?.answer || "";
        const artifacts = final.result?.artifacts || {};
        const sources   = final.result?.sources || final.result?.documents || [];

        // Ausgabe wie im Sync-Fall:
        let html = `
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
            <div>âœ… Finale Antwort:</div>
            <button type="button" id="copy-answer" class="secondary" style="width:auto">kopieren</button>
          </div>
          <pre id="answer-pre" class="prewrap mono" style="margin-top:6px;"></pre>
        `;
        html += renderSources(sources);

        if (artifacts?.code) {
          html += `<div style="margin-top:12px;font-weight:700">Code</div>
                   <pre class="prewrap mono">${escapeHtml(String(artifacts.code))}</pre>`;
        }
        if (Array.isArray(artifacts?.files) && artifacts.files.length){
          html += `<div style="margin-top:12px;font-weight:700">Dateien</div><ul>`;
          html += artifacts.files.map(f=>{
            if (f?.base64 && f?.name){
              const mime = f.mime || 'application/octet-stream';
              return `<li><a download="${escapeHtml(String(f.name))}" href="data:${mime};base64,${f.base64}">${escapeHtml(String(f.name))}</a></li>`;
            }
            if (f?.url && f?.name){
              return `<li><a href="${escapeHtml(String(f.name))}" target="_blank" rel="noopener">${escapeHtml(String(f.name))}</a></li>`;
            }
            return `<li>${escapeHtml(String(f?.name || 'Datei'))}</li>`;
          }).join('') + `</ul>`;
        }

        resultOut.innerHTML = html;
        const pre = document.getElementById('answer-pre');
        pre.textContent = String(answer || "[leer]");
        document.getElementById('copy-answer')?.addEventListener('click', ()=>{
          navigator.clipboard.writeText(pre.textContent||"");
        });
        resultDiv.className = "success";
        jobLine.textContent = "Fertig.";
      } else {
        jobLine.textContent = "Noch in Arbeit â€¦";
      }
    }

    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      const prompt = document.getElementById("prompt").value.trim();
      const model = document.getElementById("model_sys").value;
      const system = document.getElementById("system").value.trim();
      const ragVal = document.querySelector('input[name="rag"]:checked')?.value === "true";

      if (!prompt) {
        resultOut.textContent = "âš ï¸ Bitte gib einen Prompt ein.";
        resultDiv.className = "error";
        return;
      }

      resultOut.innerHTML = "";
      resultDiv.className = "";
      const hideSpinner = showFor(spinner, 300);
      submitBtn.disabled = true;

      try {
        // Modus bestimmen
        const isAgents = activeSubtab()==='subtab-agents';
        const personas = isAgents ? collectPersonas() : [];

        // Payload bauen
        const payload = { prompt, system, rag: ragVal };
        if (isAgents) {
          // Runden
          const roundsEl = document.getElementById("agent_rounds");
          const roundsVal = Number(roundsEl?.value || 1);
          if (Number.isFinite(roundsVal) && roundsVal >= 1) {
            payload.agent_rounds = Math.max(1, Math.min(10, Math.round(roundsVal)));
          }
          // Critic/Facilitator
          const criticProv = document.getElementById("critic_provider")?.value || "";
          const criticModel = (document.getElementById("critic_model")?.value || "").trim();
          if (criticProv || criticModel) {
            payload.critic = {};
            if (criticProv) payload.critic.provider = criticProv;
            if (criticModel) payload.critic.model = criticModel;
          }
        }

        if (personas.length > 0){
          payload.personas = personas;
          // Writer (optional)
          const wProv = document.getElementById('writer_provider')?.value || '';
          const wModel = (document.getElementById('writer_model')?.value || '').trim();
          if (wProv || wModel) {
            payload.writer = {};
            if (wProv) payload.writer.provider = wProv;
            if (wModel) payload.writer.model = wModel;
          }
        } else {
          payload.model = model;
        }

        // === Async fÃ¼r Agentenmodus ===
        if (isAgents && personas.length>0){
          // Jobtitel aus Prompt oder Personas
          const titleFromPrompt = prompt.split('\n')[0].slice(0, 80);
          const titleFromPersonas = personas.map(p=>p.label).slice(0,3).join(', ');
          const jobTitle = titleFromPersonas || titleFromPrompt || 'Agentenlauf';
          // Spinner weg, Status anzeigen
          hideSpinner();
          await startAsyncRun(jobTitle, payload);
          return;
        }

        // === Sync-Fallback (Systemverhalten oder keine Personas) ===
        const headers = { "Content-Type": "application/json" };
        if (isValidConversationId(conversationId)) {
          payload.conversation_id = conversationId;
          headers["x-conversation-id"] = conversationId;
        }

        const response = await fetch("/webhook/llm", {
          method: "POST",
          headers,
          body: JSON.stringify(payload),
        });
        const rawText = await response.text();
        if (!response.ok) throw new Error(rawText || `HTTP ${response.status}`);

        // --- Robustes Parsing: JSON | NDJSON | SSE -> NDJSON | Plaintext ---
        let data = null;
        let answer = "";
        const ctype = (response.headers.get('content-type')||"").toLowerCase();
        const tryJsonFirst = ()=>{ try{ data = JSON.parse(rawText); }catch{} };
        if (ctype.includes('application/json')) {
          tryJsonFirst();
        } else if (ctype.includes('text/event-stream')) {
          const nd = parseSseToNdjson(rawText);
          const txt = parseNdjsonToText(nd);
          answer = txt || nd || rawText;
        } else {
          tryJsonFirst();
          if (!data) {
            const txt = parseNdjsonToText(rawText);
            answer = txt || rawText;
          }
        }

        if (data && typeof data === 'object') {
          answer =
            data?.answer ??
            data?.raw_response?.response ??
            data?.result ??
            data?.text ??
            "";
        }

        // Conversation-ID mergen
        if (data?.conversation_id && isValidConversationId(data.conversation_id)) {
          setConversationId(data.conversation_id);
        } else if (!conversationId && window.crypto?.randomUUID) {
          setConversationId(crypto.randomUUID());
        }

        const sources   = (data?.sources ?? data?.documents ?? []);
        const artifacts = (data?.artifacts ?? {});

        // --- Ausgabe (vollstÃ¤ndig, ohne Abschneiden) ---
        let html = `
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
            <div>âœ… Fertig â€“ Antwort:</div>
            <button type="button" id="copy-answer" class="secondary" style="width:auto">kopieren</button>
          </div>
          <pre id="answer-pre" class="prewrap mono" style="margin-top:6px;"></pre>
        `;

        html += renderSources(sources);

        if (artifacts?.code) {
          html += `<div style="margin-top:12px;font-weight:700">Code</div>
                   <pre class="prewrap mono">${escapeHtml(String(artifacts.code))}</pre>`;
        }
        if (Array.isArray(artifacts?.files) && artifacts.files.length){
          html += `<div style="margin-top:12px;font-weight:700">Dateien</div><ul>`;
          html += artifacts.files.map(f=>{
            if (f?.base64 && f?.name){
              const mime = f.mime || 'application/octet-stream';
              return `<li><a download="${escapeHtml(String(f.name))}" href="data:${mime};base64,${f.base64}">${escapeHtml(String(f.name))}</a></li>`;
            }
            if (f?.url && f?.name){
              return `<li><a href="${escapeHtml(String(f.name))}" target="_blank" rel="noopener">${escapeHtml(String(f.name))}</a></li>`;
            }
            return `<li>${escapeHtml(String(f?.name || 'Datei'))}</li>`;
          }).join('') + `</ul>`;
        }

        resultOut.innerHTML = html;
        const pre = document.getElementById('answer-pre');
        pre.textContent = String(answer || (data && !answer ? JSON.stringify(data, null, 2) : rawText));
        document.getElementById('copy-answer')?.addEventListener('click', ()=>{
          navigator.clipboard.writeText(pre.textContent||"");
        });
        resultDiv.className = "success";
      } catch (err) {
        resultOut.textContent = `âŒ Fehler: ${err.message}`;
        resultDiv.className = "error";
      } finally {
        hideSpinner();
        submitBtn.disabled = false;
      }
    });

    // ---------- Dokumente indexieren ----------
    const docsForm = document.getElementById("docs-form");
    const uploadRes = document.getElementById("upload-result");
    const uploadOut = document.getElementById("upload-output");
    const uploadSpinner = document.getElementById("upload-spinner");
    const uploadBtn = document.getElementById("upload-btn");

    docsForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      const apiKey = document.getElementById("apiKey").value.trim();
      const fileEl = document.getElementById("file");
      const tagsStr = document.getElementById("tags").value.trim();

      if (!apiKey) { uploadOut.textContent = "âš ï¸ Bitte API-Key eintragen."; uploadRes.className = "error"; return; }
      if (!fileEl.files || fileEl.files.length === 0) { uploadOut.textContent = "âš ï¸ Bitte eine Datei auswÃ¤hlen."; uploadRes.className = "error"; return; }

      uploadOut.innerHTML = ""; uploadRes.className = "";
      const hideSpinner = showFor(uploadSpinner, 300);
      uploadBtn.disabled = true;

      try {
        const fd = new FormData();
        for (const f of fileEl.files) fd.append("files", f);
        if (tagsStr) tagsStr.split(",").map(t=>t.trim()).filter(Boolean).forEach(t => fd.append("tags", t));

        const resp = await fetch("/rag/index", { method: "POST", headers: { "x-api-key": apiKey }, body: fd });
        const txt = await resp.text();
        if (!resp.ok) throw new Error(txt || `Fehler ${resp.status}`);

        let data; try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
        const files = Array.isArray(data?.files) ? data.files : [];
        const tags  = data?.tags || [];
        const m     = data?.metrics || {};
        const total = typeof data?.indexed === "number" ? data.indexed : (m.total_chunks ?? files.reduce((a,b)=>a+(b.chunks||0),0));

        let html = "";
        html += `<div>âœ… Index erstellt</div>`;
        html += `<div class="inline-help" style="margin-top:6px">
          Gesamt-Chunks: <b>${Number(total||0)}</b>
          ${m.elapsed_ms!=null ? ` Â· Laufzeit gesamt: <b>${fmtMs(m.elapsed_ms)}</b>` : ""}
          ${m.pipeline_ms!=null ? ` Â· Indexieren: <b>${fmtMs(m.pipeline_ms)}</b>` : ""}
          ${m.files_count!=null ? ` Â· Dateien: <b>${m.files_count}</b>` : ""}
        </div>`;
        if (files.length){
          html += `<ul style="margin:8px 0 0 18px">` + files.map(f=>{
            const fn = escapeHtml(String(f.filename||"unbenannt"));
            const ch = Number(f.chunks||0);
            const sz = (typeof f.size_bytes==="number") ? fmtBytes(f.size_bytes) : "â€“";
            const mm = escapeHtml(String(f.mime||""));
            const cv = (typeof f.conv_ms==="number") ? fmtMs(f.conv_ms) : "â€“";
            const cs = (typeof f.chars==="number") ? `${f.chars} Zeichen` : "";
            return `<li><b>${fn}</b> <span class="inline-help">(${mm}, ${sz})</span><br/>
                    <span class="inline-help">Chunks: <b>${ch}</b>${cs?` Â· ${cs}`:""} Â· Konvertierung+Tagging: <b>${cv}</b></span></li>`;
          }).join("") + `</ul>`;
        }
        if (tags.length) html += `<div class="inline-help" style="margin-top:8px">Tags: ${tags.map(escapeHtml).join(", ")}</div>`;

        if (!files.length && data?.raw) html += `<pre style="margin-top:6px">${escapeHtml(String(data.raw))}</pre>`;

        uploadOut.innerHTML = html;
        uploadRes.className = "success";
      } catch (err) {
        uploadOut.textContent = `âŒ Fehler: ${err.message}`;
        uploadRes.className = "error";
      } finally {
        hideSpinner();
        uploadBtn.disabled = false;
      }
    });

    // ---------- Audio Upload (Transkription) ----------
    const audioForm    = document.getElementById("audio-form");
    const audioRes     = document.getElementById("audio-upload-result");
    const audioOut     = document.getElementById("audio-upload-output");
    const audioSpinner = document.getElementById("audio-upload-spinner");
    const audioBtn     = document.getElementById("audio-upload-btn");

    if (audioForm) {
      audioForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        const apiKey = document.getElementById("apiKey").value.trim();
        const fileEl = document.getElementById("audioFile");
        const tagsStr = document.getElementById("audioTags").value.trim();

        if (!apiKey) { audioOut.textContent = "âš ï¸ Bitte API-Key eintragen."; audioRes.className = "error"; return; }
        if (!fileEl.files || fileEl.files.length === 0) { audioOut.textContent = "âš ï¸ Bitte eine Audio-Datei auswÃ¤hlen (oder Mikrofon aufnehmen)."; audioRes.className = "error"; return; }

        audioOut.innerHTML = ""; audioRes.className = "";
        const hideSpinner = showFor(audioSpinner, 300);
        audioBtn.disabled = true;

        try {
          const fd = new FormData();
          fd.append("file", fileEl.files[0]);
          if (tagsStr) tagsStr.split(",").map(t=>t.trim()).filter(Boolean).forEach(t => fd.append("tags", t));
          const doDiar = document.getElementById("doDiar");
          const doIdentify = document.getElementById("doIdentify");
          const hints = document.getElementById("speakerHints");
          if (doDiar) fd.append("diarize_flag", doDiar.checked ? "true":"false");
          if (doIdentify) fd.append("identify", doIdentify.checked ? "true":"false");
          if (hints && hints.value.trim()) fd.append("speaker_hints", hints.value.trim());

          const resp = await fetch("/rag/transcribe", { method: "POST", headers: { "x-api-key": apiKey }, body: fd });
          const txt = await resp.text();
          if (!resp.ok) throw new Error(txt || `Fehler ${resp.status}`);

          let data; try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
          const segments = Array.isArray(data?.segments) ? data.segments : null;
          const transcript = data?.text ?? data?.transcript ?? data?.transcription ?? data?.result ?? (typeof data === "string" ? data : "");
          const usedTags = data?.used_tags || data?.tags || [];
          const lang = data?.language || data?.lang;
          const dur  = data?.duration || data?.audio_duration;
          const model = data?.model || data?.whisper_model;

          let html = "";
          if (transcript) {
            html += `<div>âœ… Fertig â€“ Transkript:</div>`;
            html += `<pre class="prewrap mono" style="margin-top:6px;">${escapeHtml(String(transcript))}</pre>`;
          } else {
            html += `<div>âœ… Fertig â€“ Antwort erhalten.</div>`;
            if (data?.raw) html += `<pre style="margin-top:6px">${escapeHtml(String(data.raw))}</pre>`;
          }
          if (segments && segments.length){
            html += `<div style="margin-top:10px;font-weight:700">Segmente</div>`;
            html += `<div class="timeline">` + segments.map(s => {
              const who = s.name || s.speaker || "spk";
              const t0 = fmtTime(s.start||0), t1 = fmtTime(s.end||0);
              return `<div class="seg"><b>${escapeHtml(String(who))}</b> <span class="inline-help">[${t0}â€“${t1}]</span><div>${escapeHtml(String(s.text||""))}</div></div>`;
            }).join("") + `</div>`;
          }
          const metaBits = [];
          if (lang)  metaBits.push(`Sprache: ${escapeHtml(String(lang))}`);
          if (dur)   metaBits.push(`Dauer: ${escapeHtml(String(dur))}`);
          if (model) metaBits.push(`Modell: ${escapeHtml(String(model))}`);
          if (metaBits.length) html += `<div class="inline-help" style="margin-top:6px">${metaBits.join(" Â· ")}</div>`;
          if (Array.isArray(usedTags) && usedTags.length) html += `<div class="inline-help" style="margin-top:6px">Tags: ${usedTags.map(escapeHtml).join(", ")}</div>`;

          audioOut.innerHTML = html;
          audioRes.className = "success";
        } catch (err) {
          audioOut.textContent = `âŒ Transkription fehlgeschlagen: ${err.message}`;
          audioRes.className = "error";
        } finally {
          hideSpinner();
          audioBtn.disabled = false;
        }
      });
    }

    // ---------- Sprecher Enrollment ----------
    const speakerForm    = document.getElementById("speaker-form");
    const speakerOutBox  = document.getElementById("speaker-result");
    const speakerOut     = document.getElementById("speaker-output");
    const speakerSpinner = document.getElementById("speaker-spinner");
    const speakerBtn     = document.getElementById("speaker-enroll-btn");
    const speakerRefresh = document.getElementById("speaker-refresh-btn");

    if (speakerForm) {
      speakerForm.addEventListener("submit", async function(e){
        e.preventDefault();
        const apiKey = document.getElementById("apiKey").value.trim();
        const nameEl = document.getElementById("speakerName");
        const fileEl = document.getElementById("speakerFile");
        const name = nameEl.value.trim();

        if (!name){ speakerOut.textContent = "âš ï¸ Bitte Namen angeben."; speakerOutBox.className = "error upload-box"; return; }
        if (!fileEl.files || fileEl.files.length === 0){ speakerOut.textContent = "âš ï¸ Bitte Audio-Datei wÃ¤hlen (oder Mikrofon aufnehmen)."; speakerOutBox.className = "error upload-box"; return; }

        speakerOut.innerHTML = "";
        speakerOutBox.className = "upload-box";
        const hideSpinner = showFor(speakerSpinner, 300);
        speakerBtn.disabled = true;

        try{
          const fd = new FormData();
          fd.append("name", name);
          fd.append("file", fileEl.files[0]);

          const res = await fetch("/rag/speakers/enroll", { method: "POST", headers: { "x-api-key": apiKey }, body: fd });
          const txt = await res.text();
          if (!res.ok) throw new Error(txt || `HTTP ${res.status}`);
          const data = JSON.parse(txt);

          const dim = data?.dim ?? 192;
          speakerOut.innerHTML = `âœ… Sprecher <b>${escapeHtml(name)}</b> hinzugefÃ¼gt <span class="inline-help">(Embedding-Dim: ${dim})</span>`;
          speakerOutBox.className = "success upload-box";
          await refreshSpeakers();
          nameEl.value = ""; document.getElementById("speakerFile").value = "";
        } catch (err){
          speakerOut.textContent = `âŒ Enrollment fehlgeschlagen: ${err.message}`;
          speakerOutBox.className = "error upload-box";
        } finally {
          hideSpinner();
          speakerBtn.disabled = false;
        }
      });

      speakerRefresh?.addEventListener('click', refreshSpeakers);
      // Auto-Refresh wenn Tab geÃ¶ffnet wird
      document.querySelectorAll('.tab[data-target="tab-docs"]').forEach(btn=>{
        btn.addEventListener('click', ()=> { refreshSpeakers(); });
      });
    }

    async function refreshSpeakers(){
      const apiKey = document.getElementById("apiKey").value.trim();
      const list = document.getElementById("speaker-list");
      if (!list) return;
      list.innerHTML = `<div class="inline-help">lÃ¤dtâ€¦</div>`;
      try {
        const res = await fetch("/rag/speakers", { headers: apiKey ? { "x-api-key": apiKey } : {} });
        const txt = await res.text();
        if (!res.ok) throw new Error(txt || `HTTP ${res.status}`);
        const data = JSON.parse(txt);
        if (!Array.isArray(data) || data.length === 0){
          list.innerHTML = `<div class="inline-help">Noch keine Sprecher vorhanden.</div>`;
          return;
        }
        list.innerHTML = data.map(sp => {
          const name = (sp.name ?? "Ohne Namen");
          const id   = (sp.id ?? "");
          return `<div class="seg" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
                    <div>
                      <b>${escapeHtml(String(name))}</b>
                      <div class="inline-help">ID: <span class="mono">${escapeHtml(String(id))}</span></div>
                    </div>
                    <button type="button" data-id="${escapeHtml(String(id))}" class="secondary" style="width:auto">lÃ¶schen</button>
                  </div>`;
        }).join("");
        list.querySelectorAll('button[data-id]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const apiKey = document.getElementById("apiKey").value.trim();
            const id = btn.getAttribute('data-id');
            if (!confirm(`Sprecher wirklich lÃ¶schen?\n${id}`)) return;
            const res = await fetch(`/rag/speakers/${encodeURIComponent(id)}`, {
              method: "DELETE", headers: apiKey ? { "x-api-key": apiKey } : {}
            });
            const txt = await res.text();
            if (!res.ok) { alert(`Fehler beim LÃ¶schen: ${txt||res.status}`); return; }
            await refreshSpeakers();
          });
        });
      } catch (err){
        list.innerHTML = `<div class="error">âŒ Laden fehlgeschlagen: ${escapeHtml(err.message||String(err))}</div>`;
      }
    }

    // ---------- Microphone: shared engine ----------
    const mic = {
      stream: null, rec: null, chunks: [], analyser: null, raf: 0, startTs: 0, target: null
    };

    function isSecure(){ return location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1'; }

    async function checkHardware(statusEl, selectEl){
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        statusEl.textContent = "âŒ Kein getUserMedia verfÃ¼gbar (Browser zu alt?).";
        return false;
      }
      if (!isSecure()){
        statusEl.textContent = "âŒ Unsichere Seite. Mikrofon benÃ¶tigt HTTPS oder localhost.";
        return false;
      }
      // Permission status (optional)
      try{
        if (navigator.permissions && navigator.permissions.query){
          const p = await navigator.permissions.query({name:'microphone'});
          statusEl.textContent = `Berechtigung: ${p.state}`;
        } else {
          statusEl.textContent = "Berechtigung: unbekannt";
        }
      }catch{ /* ignore */ }

      // enumerate devices (some browsers need temp stream to get labels)
      await navigator.mediaDevices.getUserMedia({audio:true}).then(s=>s.getTracks().forEach(t=>t.stop())).catch(()=>{});
      const devs = await navigator.mediaDevices.enumerateDevices();
      const inputs = devs.filter(d=>d.kind==='audioinput');
      selectEl.innerHTML = inputs.map((d,i)=>`<option value="${d.deviceId}">${d.label || `Mikrofon ${i+1}`}</option>`).join("") || `<option value="">(kein Mikro gefunden)</option>`;
      statusEl.textContent += inputs.length ? ` Â· GerÃ¤te: ${inputs.length}` : " Â· keine GerÃ¤te gefunden";
      return inputs.length>0;
    }

    async function startRecording(selectEl, statusEl, meterEl, timerEl, fileInput, label){
      try{
        const deviceId = selectEl.value || undefined;
        mic.stream = await navigator.mediaDevices.getUserMedia({ audio: deviceId ? {deviceId: {exact: deviceId}} : true });
      }catch(err){
        statusEl.textContent = `âŒ Zugriff verweigert: ${err.message||err}`;
        return false;
      }
      mic.chunks = [];
      const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus'
                 : (MediaRecorder.isTypeSupported('audio/ogg;codecs=opus') ? 'audio/ogg;codecs=opus' : '');
      mic.rec = new MediaRecorder(mic.stream, mime ? {mimeType:mime}:{});
      mic.rec.ondataavailable = e => { if (e.data && e.data.size) mic.chunks.push(e.data); };
      mic.rec.start(100); // chunk alle 100ms
      mic.startTs = Date.now();
      // Meter
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const src = ctx.createMediaStreamSource(mic.stream);
      mic.analyser = ctx.createAnalyser();
      mic.analyser.fftSize = 512;
      src.connect(mic.analyser);
      const data = new Uint8Array(mic.analyser.frequencyBinCount);
      function tick(){
        mic.analyser.getByteTimeDomainData(data);
        // simple rms
        let sum=0; for(let i=0;i<data.length;i++){ const v=(data[i]-128)/128; sum+=v*v; }
        const rms = Math.sqrt(sum/data.length);
        meterEl.style.width = Math.min(100, Math.max(2, Math.round(rms*140))) + "%";
        const secs = Math.floor((Date.now()-mic.startTs)/1000);
        timerEl.textContent = fmtTime(secs);
        mic.raf = requestAnimationFrame(tick);
      }
      tick();

      statusEl.textContent = `ðŸŽ™ï¸ Aufnahme lÃ¤uftâ€¦`;
      fileInput.dataset.recordLabel = label || "mic_recording.webm";
      return true;
    }

    async function stopRecording(statusEl, meterEl, timerEl, fileInput){
      return new Promise(resolve=>{
        try{
          mic.rec.onstop = async () => {
            cancelAnimationFrame(mic.raf);
            meterEl.style.width = "0%";
            const blob = new Blob(mic.chunks, {type: mic.chunks[0]?.type || 'audio/webm'});
            const fname = fileInput.dataset.recordLabel || "mic_recording.webm";
            // In file input setzen
            const file = new File([blob], fname, {type: blob.type});
            const dt = new DataTransfer();
            dt.items.add(file);
            fileInput.files = dt.files;

            // Stream beenden
            mic.stream.getTracks().forEach(t=>t.stop());
            mic.stream = null; mic.rec = null; mic.chunks = [];

            statusEl.textContent = `âœ… Aufnahme Ã¼bernommen (${(blob.size/1024).toFixed(1)} KB)`;
            resolve(true);
          };
          mic.rec.stop();
        }catch(err){
          statusEl.textContent = `âŒ Stop fehlgeschlagen: ${err.message||err}`;
          resolve(false);
        }
      });
    }

    // Wire up Transcribe mic controls
    const micSelectTrans  = document.getElementById('micSelectTrans');
    const micStatusTrans  = document.getElementById('micStatusTrans');
    const micCheckTrans   = document.getElementById('micCheckTrans');
    const micStartTrans   = document.getElementById('micStartTrans');
    const micStopTrans    = document.getElementById('micStopTrans');
    const micTimerTrans   = document.getElementById('micTimerTrans');
    const micMeterTrans   = document.getElementById('micMeterTrans');
    const audioFileInput  = document.getElementById('audioFile');

    micCheckTrans.addEventListener('click', ()=>checkHardware(micStatusTrans, micSelectTrans));
    micStartTrans.addEventListener('click', async ()=>{
      if (await startRecording(micSelectTrans, micStatusTrans, micMeterTrans, micTimerTrans, audioFileInput, "transcribe_mic.webm")){
        micStartTrans.disabled = true; micStopTrans.disabled = false;
      }
    });
    micStopTrans.addEventListener('click', async ()=>{
      if (await stopRecording(micStatusTrans, micMeterTrans, micTimerTrans, audioFileInput)){
        micStartTrans.disabled = false; micStopTrans.disabled = true;
      }
    });

    // Wire up Enroll mic controls
    const micSelectEnroll = document.getElementById('micSelectEnroll');
    const micStatusEnroll = document.getElementById('micStatusEnroll');
    const micCheckEnroll  = document.getElementById('micCheckEnroll');
    const micStartEnroll  = document.getElementById('micStartEnroll');
    const micStopEnroll   = document.getElementById('micStopEnroll');
    const micTimerEnroll  = document.getElementById('micTimerEnroll');
    const micMeterEnroll  = document.getElementById('micMeterEnroll');
    const speakerFileInput= document.getElementById('speakerFile');

    micCheckEnroll.addEventListener('click', ()=>checkHardware(micStatusEnroll, micSelectEnroll));
    micStartEnroll.addEventListener('click', async ()=>{
      if (await startRecording(micSelectEnroll, micStatusEnroll, micMeterEnroll, micTimerEnroll, speakerFileInput, "speaker_enroll_mic.webm")){
        micStartEnroll.disabled = true; micStopEnroll.disabled = false;
      }
    });
    micStopEnroll.addEventListener('click', async ()=>{
      if (await stopRecording(micStatusEnroll, micMeterEnroll, micTimerEnroll, speakerFileInput)){
        micStartEnroll.disabled = false; micStopEnroll.disabled = true;
      }
    });

    // Optional: beim Ã–ffnen des Tabs einmal Hardware grob prÃ¼fen
    document.querySelectorAll('.tab[data-target="tab-docs"]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        await checkHardware(micStatusTrans, micSelectTrans);
        await checkHardware(micStatusEnroll, micSelectEnroll);
      });
    });
  </script>
</body>
</html>
