<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ðŸ§  RAG UI â€“ Dateien & Anfrage</title>
  <style>
    :root { --pri:#5b6cff; --bg:#0b1020; --card:#121733; --mut:#aab3cf; --ok:#10b981; --err:#ef4444; }
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0b1020,#0f1732);color:#e7ecff;font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    h1{font-size:22px;font-weight:700;margin:10px 0 20px;display:flex;gap:10px;align-items:center}
    h1 .dot{width:10px;height:10px;border-radius:50%;background:var(--pri);box-shadow:0 0 10px var(--pri)}
    .tabs{display:flex;gap:8px;margin-bottom:16px}
    .tab{padding:10px 14px;border-radius:10px;background:#0d1430;border:1px solid #1a2455;cursor:pointer;color:#cdd6ff}
    .tab.active{background:#121a45;border-color:#2a3aa0;color:#fff}
    .card{background:var(--card);border:1px solid #1a2455;border-radius:16px;padding:16px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 360px}
    label{font-size:13px;color:#b9c3ee}
    input[type="text"], textarea{width:100%;padding:10px 12px;background:#0f1536;border:1px solid #1a2455;border-radius:10px;color:#e7ecff}
    input[type="file"]{width:100%;padding:8px;background:#0f1536;border:1px dashed #3340a0;border-radius:10px;color:#b9c3ee}
    .checks{display:flex;gap:12px;margin:10px 0}
    .checks label{display:flex;gap:8px;align-items:center;cursor:pointer}
    .btn{background:var(--pri);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .mut{color:#aab3cf;font-size:12px}
    .hr{height:1px;background:#1a2455;margin:12px 0}
    .pill{display:inline-flex;gap:6px;align-items:center;background:#0f1536;border:1px solid #2a3aa0;color:#dce2ff;border-radius:999px;padding:6px 10px;font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .result{white-space:pre-wrap;background:#0f1536;border:1px solid #1a2455;border-radius:10px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .timeline{display:flex;flex-direction:column;gap:8px}
    .seg{background:#0f1536;border:1px solid #1a2455;border-radius:10px;padding:8px}
    .seg b{color:#7cc6ff}
    .status{display:flex;align-items:center;gap:8px}
    .spinner{width:14px;height:14px;border:2px solid #3a4bbd;border-top-color:#9aa6ff;border-radius:50%;animation:spin 0.9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .ok{color:var(--ok)} .err{color:var(--err)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1><span class="dot"></span> RAG-Interface â€“ <span id="tabTitle">Dateien</span></h1>
    <div class="tabs">
      <button class="tab active" data-tab="files">Dateien</button>
      <button class="tab" data-tab="chat">Fragen</button>
    </div>

    <!-- Dateien Tab -->
    <div id="tab-files" class="card">
      <div class="row">
        <div class="col">
          <h3>Dokumente hochladen</h3>
          <input id="docFile" type="file" multiple accept=".pdf,.doc,.docx,.txt,.md,.csv,.xlsx,.pptx,.html,.htm,.json,image/*"/>
          <div class="checks">
            <label><input id="docIndex" type="checkbox" checked/> Indexieren</label>
          </div>
          <label>Tags (kommagetrennt)</label>
          <input id="docTags" type="text" placeholder="projekt, meeting, 2025-08-14"/>
          <div style="margin-top:10px">
            <button class="btn" id="btnUploadDocs">Hochladen</button>
            <span id="docStatus" class="status" style="margin-left:10px;display:none"><span class="spinner"></span> LÃ¤dt...</span>
          </div>
        </div>
        <div class="col">
          <h3>Audio hochladen</h3>
          <input id="audioFile" type="file" accept="audio/*"/>
          <div class="checks">
            <label><input id="doTranscribe" type="checkbox" checked/> Transkribieren</label>
            <label><input id="doDiar" type="checkbox" checked/> Sprecher trennen</label>
            <label><input id="doIdentify" type="checkbox" checked/> Personen identifizieren</label>
          </div>
          <label>Speaker Hints (Namen, optional)</label>
          <input id="speakerHints" type="text" placeholder="alice,bob"/>
          <label>Tags (kommagetrennt)</label>
          <input id="audioTags" type="text" placeholder="audio, meeting"/>
          <div style="margin-top:10px">
            <button class="btn" id="btnUploadAudio">Transkribieren</button>
            <span id="audioStatus" class="status" style="margin-left:10px;display:none"><span class="spinner"></span> LÃ¤uft...</span>
          </div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="grid">
        <div>
          <h3>Ergebnis</h3>
          <div id="resultText" class="result" style="display:none"></div>
        </div>
        <div>
          <h3>Segmente</h3>
          <div id="resultSegs" class="timeline"></div>
        </div>
      </div>
    </div>

    <!-- Chat Tab -->
    <div id="tab-chat" class="card" style="display:none">
      <label>Frage</label>
      <textarea id="query" rows="4" placeholder="Frag die Wissensbasis..."></textarea>
      <div style="margin-top:10px">
        <button class="btn" id="btnAsk">Fragen</button>
        <span id="qStatus" class="status" style="margin-left:10px;display:none"><span class="spinner"></span> Anfrage...</span>
      </div>
      <div class="hr"></div>
      <h3>Antwort</h3>
      <div id="answer" class="result" style="display:none"></div>
    </div>
  </div>

<script>
const $ = (sel)=>document.querySelector(sel);
const $$ = (sel)=>document.querySelectorAll(sel);

$$('.tab').forEach(b=>b.addEventListener('click', ()=>{
  $$('.tab').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  const k = b.dataset.tab;
  $('#tab-files').style.display = (k==='files')?'block':'none';
  $('#tab-chat').style.display  = (k==='chat') ?'block':'none';
  $('#tabTitle').textContent = (k==='files')?'Dateien':'Fragen';
}));

async function postForm(url, formData) {
  const res = await fetch(url, { method: 'POST', body: formData });
  if (!res.ok) throw new Error(await res.text());
  const ct = res.headers.get('content-type')||'';
  if (ct.includes('application/json')) return res.json();
  return res.text();
}

// Dokument-Upload (bestehender /index Endpunkt, falls vorhanden â€“ ansonsten ignoriere Button)
$('#btnUploadDocs').addEventListener('click', async ()=>{
  const files = $('#docFile').files;
  if(!files.length) return alert('Bitte Dateien wÃ¤hlen');
  $('#docStatus').style.display='inline-flex';
  try {
    for(const f of files){
      const fd = new FormData();
      fd.append('file', f);
      fd.append('index', $('#docIndex').checked ? 'true' : 'false');
      fd.append('tags', $('#docTags').value || '');
      await postForm('/index', fd); // dein Backend sollte /index akzeptieren
    }
    $('#docStatus').innerHTML = '<span class="ok">Fertig.</span>';
  } catch(err){
    console.error(err);
    $('#docStatus').innerHTML = '<span class="err">Fehler: '+(err.message||err)+'</span>';
  } finally {
    setTimeout(()=>$('#docStatus').style.display='none', 2500);
  }
});

// Audio-Upload -> /transcribe
$('#btnUploadAudio').addEventListener('click', async ()=>{
  const f = $('#audioFile').files[0];
  if(!f) return alert('Bitte Audio-Datei wÃ¤hlen');
  $('#audioStatus').style.display='inline-flex';
  $('#resultText').style.display='none';
  $('#resultSegs').innerHTML='';
  try {
    const fd = new FormData();
    fd.append('file', f);
    fd.append('diarize_flag', $('#doDiar').checked ? 'true':'false');
    fd.append('identify', $('#doIdentify').checked ? 'true':'false');
    fd.append('tags', $('#audioTags').value || '');
    fd.append('speaker_hints', $('#speakerHints').value || '');
    const out = await postForm('/transcribe', fd);
    $('#resultText').textContent = out.text || '';
    $('#resultText').style.display = 'block';
    const segs = out.segments || [];
    $('#resultSegs').innerHTML = segs.map(s=>{
      const who = s.name || s.speaker;
      const t = `[${fmt(s.start)}â€“${fmt(s.end)}]`;
      return `<div class="seg"><b>${who}</b> <span class="mut">${t}</span><div>${escapeHtml(s.text||'')}</div></div>`
    }).join('');
    $('#audioStatus').innerHTML = '<span class="ok">Fertig.</span>';
  } catch(err){
    console.error(err);
    $('#audioStatus').innerHTML = '<span class="err">Fehler: '+(err.message||err)+'</span>';
  } finally {
    setTimeout(()=>$('#audioStatus').style.display='none', 2500);
  }
});

function fmt(sec){ const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=(sec%60).toFixed(1); return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(4,'0')}`;}
function escapeHtml(s){return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]))}

</script>
</body>
</html>
